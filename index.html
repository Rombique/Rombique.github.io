<html>
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
  >
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>GTM test</title>
<script>
(function () {
  let bannerShown = false;
  let isNavigatingBack = false;

  // 1. Детектируем навигацию назад через pagehide/pageshow
  window.addEventListener('pagehide', function (e) {
    if (e.persisted) {
      // Safari: пользователь ушел в историю (может вернуться)
      isNavigatingBack = true;
      sessionStorage.setItem('was-navigating-back', 'true');
    }
  });

  window.addEventListener('pageshow', function (e) {
    if (e.persisted) {
      // Safari: пользователь вернулся назад (back button или swipe)
      showBanner();
    }
  });

  // 2. Desktop: старый способ через popstate
  function lockHistory() {
    history.pushState({ locked: true }, null);
    
    window.addEventListener('popstate', function (e) {
      history.pushState({ locked: true }, null);
      showBanner();
    });
  }

  // 3. Mobile: свайп назад (iOS/Android)
  let touchStartX = null;
  let touchStartY = null;

  document.addEventListener('touchstart', function (e) {
    const t = e.touches[0];
    touchStartX = t.clientX;
    touchStartY = t.clientY;
  }, false);

  document.addEventListener('touchmove', function (e) {
    if (touchStartX !== null && e.touches[0].clientX - touchStartX > 50) {
      if (Math.abs(e.touches[0].clientY - touchStartY) < 50) {
        e.preventDefault();
        showBanner();
        touchStartX = null;
      }
    }
  }, { passive: false });

  document.addEventListener('touchend', function (e) {
    if (touchStartX !== null && e.changedTouches[0].clientX - touchStartX > 50) {
      e.preventDefault();
      showBanner();
    }
    touchStartX = touchStartY = null;
  }, { passive: false });

  // 4. Баннер
  function showBanner() {
    if (bannerShown || document.getElementById('bounce-back-banner')) return;
    bannerShown = true;

    const overlay = document.createElement('div');
    overlay.id = 'bounce-back-banner';
    overlay.innerHTML = `
      <div class="banner-modal">
        <button class="banner-close" aria-label="Закрыть">×</button>
        <img src="https://placehold.co/300x150" alt="Ваш баннер" style="max-width:100%;height:auto;display:block;margin:0 auto;">
      </div>
    `;
    overlay.style.cssText = `
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    `;
    overlay.querySelector('.banner-modal').style.cssText = `
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      max-width: 90vw;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      position: relative;
    `;
    overlay.querySelector('.banner-close').style.cssText = `
      position: absolute;
      top: 8px; right: 8px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #333;
    `;
    
    overlay.querySelector('.banner-close').onclick = () => {
      overlay.remove();
      bannerShown = false;
    };

    // ESC key
    const escListener = (e) => {
      if (e.key === 'Escape') {
        overlay.remove();
        document.removeEventListener('keydown', escListener);
        bannerShown = false;
      }
    };
    document.addEventListener('keydown', escListener);

    document.body.appendChild(overlay);
  }

  // Init
  lockHistory();
  window.addEventListener('load', lockHistory);
</script>
<body>
 <h1>Hello worldd! </h1>
<a href="https://rombique.github.io/page2.html">Second page</a>
</body>
</html>
