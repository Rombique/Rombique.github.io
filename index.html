<html>
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
  >
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>GTM test</title>
<script>
(function () {
  let bannerShown = false;
  let lastMouseY = window.innerHeight / 2;

  // 1. Exit Intent: курсор вверх экрана (десктоп)
  document.addEventListener('mouseleave', function (e) {
    if (e.clientY <= 0 && !bannerShown) {
      showBanner();
    }
  });

  // 2. Mouse move вверх (дополнительная защита)
  document.addEventListener('mousemove', function (e) {
    lastMouseY = e.clientY;
    
    // Если курсор у верхней границы + движение вверх
    if (lastMouseY < 5 && e.movementY < 0 && !bannerShown) {
      showBanner();
    }
  });

  // 3. Мобильный: свайп вверх/вниз (имитация ухода)
  let touchStartY = null;
  document.addEventListener('touchstart', function (e) {
    touchStartY = e.touches[0].clientY;
  });

  document.addEventListener('touchmove', function (e) {
    if (touchStartY !== null) {
      const currentY = e.touches[0].clientY;
      
      // Быстрый свайп вверх (попытка закрыть вкладку)
      if (touchStartY - currentY > 100) {
        e.preventDefault();
        showBanner();
        touchStartY = null;
      }
    }
  }, { passive: false });

  document.addEventListener('touchend', function () {
    touchStartY = null;
  });

  // 4. Блокировка кнопки "назад" (внутри домена)
  function lockHistory() {
    if (history.state?.locked) return;
    
    history.pushState({ locked: true }, null);
    window.addEventListener('popstate', function (e) {
      if (history.state?.locked) {
        history.pushState({ locked: true }, null);
        showBanner();
      }
    });
  }

  // 5. Before unload (дополнительно)
  window.addEventListener('beforeunload', function () {
    // Стандартный диалог браузера при уходе
  });

  // Баннер (тот же)
  function showBanner() {
    if (bannerShown || document.getElementById('bounce-back-banner')) return;
    bannerShown = true;

    const overlay = document.createElement('div');
    overlay.id = 'bounce-back-banner';
    overlay.innerHTML = `
      <div class="banner-modal">
        <button class="banner-close" aria-label="Закрыть">×</button>
        <img src="https://placehold.co/600x400" alt="Не уходите!" style="max-width:100%;height:auto;display:block;margin:0 auto;">
        <p style="text-align:center;margin:16px 0 0 0;color:#666;">У вас есть эксклюзивное предложение!</p>
      </div>
    `;
    
    // Стили (те же)
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
      z-index: 99999; backdrop-filter: blur(5px);
    `;
    overlay.querySelector('.banner-modal').style.cssText = `
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px; padding: 32px; max-width: 90vw; max-height: 80vh;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative; color: white;
    `;
    overlay.querySelector('.banner-close').style.cssText = `
      position: absolute; top: 12px; right: 16px; background: rgba(255,255,255,0.2);
      border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 18px;
      color: white; cursor: pointer; backdrop-filter: blur(10px);
    `;
    
    overlay.querySelector('.banner-close').onclick = () => {
      overlay.remove();
      bannerShown = false;
    };

    // ESC + overlay click
    const escListener = (e) => {
      if (e.key === 'Escape') {
        overlay.remove();
        document.removeEventListener('keydown', escListener);
        bannerShown = false;
      }
    };
    overlay.onclick = (e) => {
      if (e.target === overlay) {
        overlay.remove();
        bannerShown = false;
      }
    };
    document.addEventListener('keydown', escListener);

    document.body.appendChild(overlay);
  }

  // Init
  lockHistory();
  window.addEventListener('load', lockHistory);
})();

</script>
<body>
 <h1>Hello worldd! </h1>
<a href="https://rombique.github.io/page2.html">Second page</a>
</body>
</html>
